{% extends "base.html" %}
{% block content %}
<div class="results-header">
    <h1>Custom Scan Results</h1>
    <p class="results-subtitle">Vulnerability scan results for: <code>{{ data.scan_path }}</code></p>
</div>

<div class="results-container">
    <div class="scan-summary-card">
        <div class="summary-header">
            <h2>üìä Scan Summary</h2>
            <div class="scan-status {{ 'error' if data.osv.error else ('warning' if data.vulns else 'success') }}">
                {% if data.osv.error %}
                    ‚ùå Scan Failed
                {% elif data.vulns %}
                    ‚ö†Ô∏è Vulnerabilities Found
                {% else %}
                    ‚úÖ No Issues Found
                {% endif %}
            </div>
        </div>
        
        <div class="summary-content">
            <div class="summary-stats">
                <div class="stat-item">
                    <div class="stat-number">{{ data.vulns.values() | sum if data.vulns else 0 }}</div>
                    <div class="stat-label">Total Vulnerabilities</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">{{ data.vulns.keys() | length if data.vulns else 0 }}</div>
                    <div class="stat-label">Affected Packages</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">{{ data.scan_path | length }}</div>
                    <div class="stat-label">Path Length</div>
                </div>
            </div>
        </div>
    </div>

    {% if data.osv.error %}
        <div class="error-card">
            <div class="error-header">
                <h3>‚ùå Scan Error</h3>
            </div>
            <div class="error-content">
                <p class="error-message">{{ data.osv.error }}</p>
                {% if data.osv.stderr %}
                    <details class="error-details">
                        <summary>Technical Details</summary>
                        <pre>{{ data.osv.stderr }}</pre>
                    </details>
                {% endif %}
                
                <div class="error-suggestions">
                    <h4>üí° Troubleshooting Tips:</h4>
                    <ul>
                        <li>Ensure you have read permissions for the scanned directory</li>
                        <li>Try running the application as administrator for system directories</li>
                        <li>Check that the path exists and is accessible</li>
                        <li>Verify OSV-Scanner is properly installed</li>
                    </ul>
                </div>
            </div>
        </div>
    {% elif data.vulns %}
        <div class="vulnerabilities-card">
            <div class="vuln-header">
                <h3>üîç Detected Vulnerabilities</h3>
                <span class="vuln-count">{{ data.vulns.values() | sum }} total issues</span>
            </div>
            <div class="vuln-content">
                <div class="vuln-list">
                    {% for package, count in data.vulns.items() %}
                        <div class="vuln-item">
                            <div class="vuln-package">
                                <span class="package-name">{{ package }}</span>
                                <span class="vuln-badge">{{ count }} vulnerabilities</span>
                            </div>
                            <div class="vuln-severity">
                                {% if count >= 10 %}
                                    <span class="severity-high">High Risk</span>
                                {% elif count >= 5 %}
                                    <span class="severity-medium">Medium Risk</span>
                                {% else %}
                                    <span class="severity-low">Low Risk</span>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    {% else %}
        <div class="success-card">
            <div class="success-header">
                <h3>‚úÖ Clean Scan</h3>
            </div>
            <div class="success-content">
                <p>No vulnerabilities were detected in the scanned directory.</p>
                <div class="success-details">
                    {% if data.osv.results %}
                        <p><strong>OSV Scanner Result:</strong> {{ data.osv.results }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    {% endif %}

    {% if data.osv.raw_output %}
        <div class="raw-output-card">
            <div class="output-header">
                <h3>üìã Raw Scanner Output</h3>
            </div>
            <div class="output-content">
                <pre class="raw-output">{{ data.osv.raw_output }}</pre>
            </div>
        </div>
    {% endif %}
</div>

<div class="action-buttons">
    <a href="{{ url_for('custom_scan') }}" class="btn btn-primary">üîç New Scan</a>
    <a href="{{ url_for('history') }}" class="btn btn-secondary">üìã View History</a>
    <a href="{{ url_for('status') }}" class="btn btn-outline">‚Üê Back to Status</a>
</div>

<style>
.results-header {
    text-align: center;
    margin-bottom: 2rem;
}

.results-header h1 {
    font-size: 2.2rem;
    color: #495057;
    margin-bottom: 0.5rem;
    font-weight: 700;
}

.results-subtitle {
    font-size: 1rem;
    color: #6c757d;
    margin: 0;
}

.results-subtitle code {
    background: #f8f9fa;
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    font-family: monospace;
    color: #495057;
}

.results-container {
    max-width: 1000px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.scan-summary-card,
.error-card,
.vulnerabilities-card,
.success-card,
.raw-output-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    overflow: hidden;
}

.summary-header,
.error-header,
.vuln-header,
.success-header,
.output-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.summary-header h2,
.error-header h3,
.vuln-header h3,
.success-header h3,
.output-header h3 {
    margin: 0;
    font-size: 1.3rem;
    font-weight: 600;
}

.scan-status {
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 500;
}

.scan-status.success {
    background: rgba(40, 167, 69, 0.2);
}

.scan-status.warning {
    background: rgba(255, 193, 7, 0.2);
}

.scan-status.error {
    background: rgba(220, 53, 69, 0.2);
}

.summary-content,
.error-content,
.vuln-content,
.success-content,
.output-content {
    padding: 1.5rem;
}

.summary-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
}

.stat-item {
    text-align: center;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
}

.stat-number {
    font-size: 2rem;
    font-weight: 700;
    color: #667eea;
    margin-bottom: 0.5rem;
}

.stat-label {
    font-size: 0.9rem;
    color: #6c757d;
    font-weight: 500;
}

.error-message {
    color: #dc3545;
    font-weight: 500;
    margin-bottom: 1rem;
}

.error-details {
    margin: 1rem 0;
}

.error-details pre {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 4px;
    overflow-x: auto;
    font-size: 0.85rem;
}

.error-suggestions h4 {
    color: #495057;
    margin-bottom: 0.5rem;
}

.error-suggestions ul {
    color: #6c757d;
    padding-left: 1.5rem;
}

.vuln-count {
    background: rgba(255, 255, 255, 0.2);
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
}

.vuln-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.vuln-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #ffc107;
}

.package-name {
    font-weight: 600;
    color: #495057;
    margin-right: 1rem;
}

.vuln-badge {
    background: #dc3545;
    color: white;
    padding: 0.2rem 0.6rem;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 500;
}

.severity-high {
    background: #dc3545;
    color: white;
    padding: 0.3rem 0.6rem;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 600;
}

.severity-medium {
    background: #ffc107;
    color: #212529;
    padding: 0.3rem 0.6rem;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 600;
}

.severity-low {
    background: #28a745;
    color: white;
    padding: 0.3rem 0.6rem;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 600;
}

.raw-output {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 4px;
    overflow-x: auto;
    font-size: 0.85rem;
    line-height: 1.4;
    max-height: 300px;
    overflow-y: auto;
}

.action-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin: 2rem 0;
    flex-wrap: wrap;
}

@media (max-width: 768px) {
    .summary-stats {
        grid-template-columns: 1fr;
    }
    
    .vuln-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
    
    .action-buttons {
        flex-direction: column;
        align-items: center;
    }
}
</style>
{% endblock %}